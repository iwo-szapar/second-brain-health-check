/**
 * Brain Manifest Generator
 *
 * Produces a machine-readable YAML manifest from health check results.
 * Other tools (Guide MCP, CI pipelines, team dashboards) can consume this.
 */
import { writeFile } from 'node:fs/promises';
import { resolve } from 'node:path';
import { VERSION } from './version.js';

export function generateManifestYaml(report) {
    const ts = report.timestamp ? new Date(report.timestamp).toISOString() : new Date().toISOString();
    const overallPct = (report.setup.maxPoints + report.usage.maxPoints + report.fluency.maxPoints) > 0
        ? Math.round(((report.setup.totalPoints + report.usage.totalPoints + report.fluency.totalPoints) /
            (report.setup.maxPoints + report.usage.maxPoints + report.fluency.maxPoints)) * 100)
        : 0;

    const lines = [
        '# Brain Manifest â€” generated by second-brain-health-check',
        `version: "${VERSION}"`,
        `scanned_at: "${ts}"`,
        '',
        'scores:',
        `  setup: ${report.setup.normalizedScore}`,
        `  usage: ${report.usage.normalizedScore}`,
        `  fluency: ${report.fluency.normalizedScore}`,
        `  overall_pct: ${overallPct}`,
        `  stage: "${report.brainState?.maturity || 'unknown'}"`,
        '',
        'layers:',
    ];

    const allLayers = [
        ...(report.setup?.layers || []),
        ...(report.usage?.layers || []),
        ...(report.fluency?.layers || []),
    ];
    for (const layer of allLayers) {
        const key = layer.name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
        const status = layer.points === layer.maxPoints ? 'pass' : layer.points > 0 ? 'warn' : 'fail';
        lines.push(`  ${key}: { score: ${layer.points}, max: ${layer.maxPoints}, status: "${status}" }`);
    }

    if (report.cePatterns && report.cePatterns.length > 0) {
        lines.push('');
        lines.push('ce_patterns:');
        for (const p of report.cePatterns) {
            const key = p.id || p.name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            lines.push(`  ${key}: ${p.percentage}`);
        }
    }

    if (report.topFixes && report.topFixes.length > 0) {
        lines.push('');
        lines.push('top_fixes:');
        for (const fix of report.topFixes.slice(0, 5)) {
            lines.push(`  - title: "${fix.name}"`);
            lines.push(`    impact_pct: ${fix.impactPct || 0}`);
            if (fix.estimatedMinutes) lines.push(`    estimated_minutes: ${fix.estimatedMinutes}`);
            if (fix.cePattern) lines.push(`    ce_pattern: "${fix.cePattern}"`);
        }
    }

    lines.push('');
    return lines.join('\n');
}

export async function saveManifest(report, outputPath) {
    const yaml = generateManifestYaml(report);
    const filePath = outputPath || resolve(process.cwd(), 'brain-manifest.yaml');
    await writeFile(filePath, yaml, 'utf-8');
    return filePath;
}
